<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#FF9800" />
    <title>Tap Tap Tap</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
    />
  </head>
  <body>
    <main id="app" class="w-screen h-screen"></main>
  </body>
  <script type="module">
    import {
      getProperty,
      getProfile,
      signIn,
    } from "https://auth.homebots.io/auth.js";

    const colors = [
      { rgb: "#ff0000", angle: 0, name: "red" },
      { rgb: "#ffff00", angle: 60, name: "yellow" },
      { rgb: "#00ff00", angle: 120, name: "green" },
      { rgb: "#00ffff", angle: 180, name: "light blue" },
      { rgb: "#0000ff", angle: 240, name: "blue" },
    ];

    let properties;

    async function getProperties() {
      if (!properties) {
        const clientId = await getProperty("rct:clientId");
        const clientSecret = await getProperty("rct:clientSecret");
        const deviceIds = await getProperty("rct:deviceIds");
        const interval = await getProperty("rct:interval");
        const resetTimeout = await getProperty("rct:resetTimeout");

        properties = {
          clientId: clientId.value,
          clientSecret: clientSecret.value,
          deviceIds: deviceIds.value.split(",").map((s) => s.trim()),
          interval: Number(interval.value) || 1000,
          resetTimeout: Number(resetTimeout.value) || 3000,
        };
      }

      return properties;
    }

    function debounce(fn, time = 1000) {
      let timer;
      return function (...args) {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), time);
      };
    }

    function delay(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }

    function speak(text) {
      if (window.speechSynthesis) {
        speechSynthesis.speak(new SpeechSynthesisUtterance(text));
      }
    }

    const applyColor = async (colorString) => {
      const { clientId, clientSecret, deviceIds } = await getProperties();

      for (const deviceId of deviceIds) {
        await fetch("/tap/" + deviceId + "/" + colorString, {
          headers: { clientId, clientSecret },
        });

        await delay(200);
      }
    };

    const reset = async () => {
      const { clientId, clientSecret, deviceIds } = await getProperties();

      for (const deviceId of deviceIds) {
        await fetch("/reset/" + deviceIds, {
          headers: { clientId, clientSecret },
        });
      }
    };

    window.addEventListener("DOMContentLoaded", async () => {
      const main = document.querySelector("main");
      const theme = document.head.querySelector('meta[name="theme-color"]');

      try {
        await getProfile();
      } catch {
        signIn();
      }

      const props = await getProperties();
      const apply = debounce(applyColor, props.interval);
      let lastStamp = Date.now();

      const changeColor = async function () {
        const index = 1 + (Math.floor(Math.random() * 100) % colors.length) - 1;
        const color = colors[index];
        const colorString = [color.angle, 100, 100].join(",");

        main.style.backgroundColor = color.rgb;
        theme.content = color.rgb;

        speak(color.name);
        apply(colorString);
      };

      function startChange() {
        lastStamp = Date.now();
      }

      function stopChange() {
        if (Date.now() - lastStamp > props.resetTimeout) {
          main.style.backgroundColor = theme.content = "#ffffff";
          return reset();
        }

        apply();
      }

      main.onmousedown = main.ontouchstart = startChange;
      main.onmouseup = main.ontouchend = stopChange;
    });
  </script>
  <style>
    main {
      transition: background-color 0.75s ease;
    }
  </style>
</html>
